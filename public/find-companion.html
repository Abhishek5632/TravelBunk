<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Find Your Travel Companion | TravelBuddy</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {
      font-family: 'Poppins', sans-serif;
      background: #F4F9F9;
      color: #2D3436;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navbar */
    .navbar {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 20px rgba(0,191,166,0.07);
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 70px;
    }
    .nav-logo h2 {color:#00BFA6;font-size:1.7rem;font-weight:700;}
    .nav-menu {display:flex;list-style:none;gap:2rem;}
    .nav-menu li a {
      text-decoration: none;
      color: #2D3436;
      font-weight: 500;
      position: relative;
      padding: 5px 0;
      transition: color 0.3s;
    }
    .nav-menu li a:hover {color:#00BFA6;}
    .nav-menu li a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      background: #00BFA6;
      bottom: -5px;
      left: 0;
      transition: 0.3s;
    }
    .nav-menu li a:hover::after {width: 100%;}
    .hamburger {display:none;flex-direction:column;cursor:pointer;}
    .hamburger span {width:25px;height:3px;background:#2D3436;margin:3px 0;border-radius:2px;}
    @media(max-width:768px){
      .nav-menu {position:fixed;top:70px;left:-100%;flex-direction:column;background:white;width:100%;padding:2rem 0;transition:0.3s;box-shadow:0 10px 27px rgba(0,0,0,0.05);}
      .nav-menu.active {left:0;}
      .hamburger {display:flex;}
      .nav-logo h2 {font-size:1.3rem;}
    }


    /* Hero */
    .page-hero {
      background: linear-gradient(135deg,#00BFA6,#FDCB6E);
      padding: 130px 20px 70px;
      text-align: center;
      color: white;
      flex-shrink: 0;
    }
    .page-hero h1 {font-size:3rem;font-weight:700;margin-bottom:1rem;}
    .page-hero p {font-size:1.25rem;opacity:0.92;}


    /* Content */
    .page-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      max-width:1200px;
      margin:0 auto;
      padding:50px 20px 70px;
      width: 100%;
    }


    .search-box {
      background:white;border-radius:14px;
      box-shadow:0 4px 16px rgba(0,0,0,0.10);
      padding:25px;
      display:flex;flex-wrap:wrap;justify-content:center;align-items:center;
      gap:20px;max-width:750px;margin:0 auto 30px;
    }
    .search-box input {
      padding:9px 14px;border:1px solid #ccc;border-radius:10px;font-size:15px;
      outline:none;transition:0.3s;
    }
    .search-box input:focus {border-color:#00BFA6;box-shadow:0 0 5px #00bfa644;}
    .search-box button {
      padding:9px 22px;border:none;border-radius:10px;
      background:linear-gradient(135deg,#00BFA6,#FDCB6E);
      color:white;cursor:pointer;font-weight:600;font-size:16px;
      transition:0.3s;box-shadow:0 2px 12px rgba(0,191,166,0.08);
    }
    .search-box button:hover {transform:scale(1.05);}


    #noResults {
      text-align:center;color:#00BFA6;font-weight:600;
      margin-top:38px;font-size:1.18rem;
    }


    #resultsContainer {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(270px,1fr));
      gap:22px;
      margin-top:20px;
    }


    .card {
      background:white;border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,0.09);
      overflow:hidden;transition:0.28s;
      display:flex;flex-direction:column;
    }
    .card:hover {transform:scale(1.03);}
    .card img {width:100%;height:175px;object-fit:cover;}
    .card-content {padding:17px 16px 14px;}
    .card-content h2 {color:#00BFA6;font-size:1.18rem;font-weight:700;}
    .card-content p {margin:4px 0;color:#444;font-size:0.95rem;}
    .card-content b {color:#2D3436;}
    .view-btn {
      margin-top:10px;
      padding:8px 12px;
      border:none;
      border-radius:8px;
      background:linear-gradient(135deg,#00BFA6,#FDCB6E);
      color:white;
      font-weight:600;
      cursor:pointer;
      transition:0.3s;
      text-decoration:none;
      display:inline-block;
      text-align:center;
    }
    .view-btn:hover {transform:scale(1.05);}


    /* Footer */
    .footer {
      background:#2D3436;
      color:white;
      text-align:center;
      padding:2.5rem 20px;
      flex-shrink: 0;
    }
    .footer h3 {color:#00BFA6;}


    /* Skeleton Loading */
    .skeleton {
      position: relative;
      overflow: hidden;
    }
    .skeleton-img {
      width: 100%;
      height: 175px;
      background: #eee;
      border-radius: 14px 14px 0 0;
    }
    .skeleton-line {
      height: 12px;
      background: #eee;
      border-radius: 6px;
      margin: 8px 0;
    }
    .skeleton::after {
      content: "";
      position: absolute;
      top: 0; left: -150px;
      width: 100px; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 1.3s infinite;
    }
    @keyframes shimmer {
      100% { left: 100%; }
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo"><h2>TravelBuddy</h2></div>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="find-companion.html">Find Companion</a></li>
        <li><a href="explore.html">Add Trip</a></li>
        <li><a href="profile.html">Profile</a></li>
      </ul>
      <div class="hamburger"><span></span><span></span><span></span></div>
    </div>
  </nav>

  <section class="page-hero">
    <h1>Find Your Travel Companion</h1>
    <p>Connect with fellow travelers and make your journeys memorable!</p>
  </section>

  <section class="page-content">
    <div class="search-box">
      <label>Date:</label>
      <input type="date" id="tripDate" />
      <label>Destination:</label>
      <input type="text" id="destination" placeholder="e.g. Jaipur, Goa, Delhi" />
      <button onclick="searchTrips()">üîç Search</button>
    </div>
    <p id="noResults" style="display:none;">No travelers found for this trip üòî</p>
    <div id="resultsContainer"></div>
  </section>

  <footer class="footer">
    <h3>TravelBuddy</h3>
    <p>&copy; 2025 TravelBuddy. All rights reserved.</p>
  </footer>

  <script>
    // Redirect if user not logged in
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      alert("Please log in first to access this page.");
      window.location.href = "signin.html";
    }

    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector(".nav-menu");
    hamburger.addEventListener("click", () => navMenu.classList.toggle("active"));

    const baseURL = window.location.hostname === "localhost"
      ? "http://localhost:5001"
      : "https://travelbuddy-hluu.onrender.com";

    const container = document.getElementById("resultsContainer");
    const noResults = document.getElementById("noResults");

    // Fetch early to wake backend
    fetch(`${baseURL}/api/ping`).catch(() => {});

    // Show skeleton placeholders
    function showSkeletons(count = 6) {
      container.innerHTML = "";
      for (let i = 0; i < count; i++) {
        container.innerHTML += `
          <div class="card skeleton">
            <div class="skeleton-img"></div>
            <div class="card-content">
              <div class="skeleton-line" style="width:60%"></div>
              <div class="skeleton-line" style="width:80%"></div>
              <div class="skeleton-line" style="width:70%"></div>
            </div>
          </div>`;
      }
    }

    // Improved user render: build HTML string once
    function renderUsers(users) {
      let html = "";
      users.forEach(user => {
        const trip = user.trips && user.trips[0] ? user.trips[0] : { date: "N/A", destination: "Not Added" };
        const img = user.img || "https://images.unsplash.com/photo-1511367461989-f85a21fda167?auto=format&fit=facearea&w=400&h=300&facepad=2";
        html += `
          <div class="card">
            <img src="${img}" alt="${user.firstName}" loading="lazy">
            <div class="card-content">
              <h2>${user.firstName || "Unknown"} ${user.lastName || ""}</h2>
              <p><b>College:</b> ${user.college || "Not Mentioned"}</p>
              <p><b>Date:</b> ${trip.date}</p>
              <p><b>Destination:</b> ${trip.destination}</p>
              <a class="view-btn" href="profile.html?email=${encodeURIComponent(user.email)}">View Profile</a>
            </div>
          </div>`;
      });
      container.innerHTML = html;
    }

    // Load all users with retry on page load
    window.addEventListener("load", async () => {
      showSkeletons();
      noResults.style.display = "block";
      noResults.textContent = "‚è≥ Connecting to server... please wait";

      let attempt = 0;
      let loaded = false;

      while (attempt < 2 && !loaded) {
        try {
          const res = await fetch(`${baseURL}/api/get-all-users`);
          const data = await res.json();

          if (data.success && data.users?.length > 0) {
            renderUsers(data.users.slice(0, 10));
            noResults.style.display = "none";
            loaded = true;
          } else {
            noResults.style.display = "block";
            noResults.textContent = "No travelers found üòî";
          }
        } catch (err) {
          attempt++;
          console.warn(`Attempt ${attempt} failed, retrying...`);
          noResults.style.display = "block";
          noResults.textContent = "‚öôÔ∏è Server waking up... retrying in 3 seconds";

          if (attempt < 2) {
            await new Promise(resolve => setTimeout(resolve, 3000)); // wait 3 sec
          } else {
            noResults.textContent = "‚ùå Unable to reach server. Please refresh after a few seconds.";
          }
        }
      }
    });

    // Fetch with timeout utility to prevent hanging
    async function fetchWithTimeout(url, options = {}, timeout = 5000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
      } catch (e) {
        clearTimeout(id);
        throw e;
      }
    }

    // Search trips optimized
    async function searchTrips() {
      const date = document.getElementById("tripDate").value;
      const destination = document.getElementById("destination").value.trim();
      if (!date || !destination) {
        alert("Please enter both date and destination.");
        return;
      }
      showSkeletons(4);
      noResults.style.display = "none";

      try {
        const res = await fetchWithTimeout(`${baseURL}/api/find-users-by-trip`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ date, destination }),
        }, 5000);

        const data = await res.json();
        if (!data.success || !data.users?.length) {
          container.innerHTML = "";
          noResults.style.display = "block";
          noResults.textContent = "No travelers found for this trip üòî";
        } else {
          noResults.style.display = "none";
          renderUsers(data.users);
        }
      } catch (err) {
        console.error("‚ùå Fetch Error:", err);
        container.innerHTML = "";
        noResults.style.display = "block";
        noResults.textContent = "‚ùå Unable to connect. Please try again later.";
      }
    }
  </script>
</body>
</html>
